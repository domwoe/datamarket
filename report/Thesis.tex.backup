\documentclass[a4paper, oneside]{discothesis}

% use utf8 instead of latin1 when using LaTeX in windows
\usepackage[latin1]{inputenc}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% DOCUMENT METADATA

\thesistype{Master Thesis}
\title{Towards Datamarkets with Bitcoin}

\author{Francisc Nicolae Bungiu}
\email{fbungiu@student@ethz.ch}
\institute{Distributed Computing Group \\[2pt]
Computer Engineering and Networks Laboratory \\[2pt]
ETH Zürich}

% You can put in your own logo here "\includegraphics{...}" or just comment the command
% \logo{}

\supervisors{Christian Decker, Dominic W{\"o}rner, Laura Peer\\[2pt] Prof.\ Dr.\ Roger Wattenhofer}

% You can comment the following two commands if you don't need them
% \keywords{Keywords go here.}
% \categories{ACM categories go here.}

\date{\today}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\frontmatter % do not remove this line
\maketitle

\cleardoublepage

\begin{acknowledgements}
	I thank Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.
\end{acknowledgements}


\begin{abstract}

\hspace*{12pt} In recent years, there has been a widespread expansion of data collection and complex methods to analyze such 
collected data. Everyone is constantly generating data by using a large range of computers, smartphones, and gadgets.
In addition, there is an emerging trend towards the Internet of Things technologies that consist
of billions of sensor nodes bridging the gap between the physical and the digital world, and creating massive amounts
of data, but with no incentive to share. 

	In order to provide an incentive for the sensor node owners to share the generated data, these sensor networks
have to initiate data markets that interested customers can subscribe to and pay for the acquired data. Bitcoin provides
an Internet-native payment mechanism and protocols on top of Bitcoin are able to support small payments and avoid 
high cumulated transaction processing costs.

	This thesis proposes a centralized secure scheme that allows data purchasing from any Internet-connected sensor
node using the Bitcoin payments. Based on micropayment channels to aggregate payments and minimize transaction fees, 
and on contracts between the protocol participants to minimize trust, the scheme allows human judgements to be taken
out of the loop and supports complete automation. 
\end{abstract}

\tableofcontents

\mainmatter % do not remove this line

% Start writing here
\chapter{Introduction}

\hspace*{12pt} The Internet of Things (IoT) is a novel concept that has rapidly expanded in the latest years, refering to the
network formed by any physical object, embedded with sensors and connectivity - such as Radio-Frequency 
Identification (RFID) tags, sensors, smartphones, etc. - that enables such nodes to exchange
data. This technology allows these objects to be sensed and controlled remotely (IoT Survey), having a great
impact on the every-day life of users, and resulting in efficiency and financial benefits.

Sensor nodes with Internet connectivity enable attractive sensing applications in various domains, ranging from
health-care, security and surveillance, environmental monitoring, agriculture automation, energy consumption, transportation, etc.
(Sensing as a Service paper) introduces the concept of Sensing as a Service, in which a number of sensors offer
their generated data as a service to interested entities through a central operator in exchange for a pre-established
price quote. 

Most existing payment protocols for the Sensing as a Service model involve a third-party, which results in higher costs and reduced
efficiency. Another approach is to rely on Bitcoin, a decentralized electronic payment system. 
Bitcoin has at its root the blockchain, a transaction database that is shared by all network 
nodes. However, these solutions fail to address the scalability problem of Bitcoin: 
they rely on atomic operations that are completed directly on the blockchain, thus increasing its size and moving Bitcoin
towards centralization, since only a few nodes will be able to process a block. 

IoT has a huge economic potential and areas of application include: road surveillance - interested in road condition data generated by cars (Nericell, VTrack), 
weather forecast - in data sensed by private weather stations, transportation - paying per distance or number of bus stops, 
paying for Internet by used traffic, etc. 
In this manner, IoT entities can act as active participants in a self-created data market. However, it is still lacking
an efficient payment method and is limited by high transaction costs.

In this context, the project proposes a centralized, low-trust and secure scheme that allows and incentivizes sensor nodes
to share sensed data and get paid in exchange in bitcoins. The presented solution utilizes micropayment channels
to solve Bitcoin's scalability problem by bundling several small payments for each set of acquired data and only
publishing the final, aggregated transaction to the network. In order to confer a low-trust relation between the system 
entities, the protocol relies on contracts that pass the payment obligation down from the buyer to the central coordinator,
and then to the sensor node. In addition to the theoretical model, a proof-of-concept is built based on the Android built-in
sensors.

\section{Bitcoin}

\hspace*{12pt} Since its invention in 2008 [Satoshi paper], Bitcoin has grown into a global electronic payment system.
It uses peer-to-peer technology to transfer funds, with no need for a central authority such as a financial institution
and low transaction fees, making it an attractive alternative to traditional payment methods.
A proof-of-work system and cryptographic protocols are the building blocks of the protocol, with peers participating
in the network being responsible for processing transactions and issuing of bitcoins. 

Bitcoin relies on public key cryptography to authenticate transactions. Each peer in the network has one or more 
public and private key pairs that are stored in a file called a wallet. In order to support and authenticate transactions, 
an address is derived from the public key and is disclosed together with it to the participants.
In this cash system, transactions consist of one or more inputs (references to previous transaction outputs)
assigning the value of all inputs to one or more outputs. The difference between the total input amount and the total
output amount represents the transaction fee.
A peer holding a private key can sign a transaction spending some of its wallet's amount to some other address, and 
any other peer that sees this transaction can verify the signature using the peer's public key. In order to claim an
output, the payee must prove that it possesses the private key corresponding to the public key included as the destination
of the transaction. Thus, the available funds are represented by the amount of all unspent transaction outputs the peer possesses a private key for.

In order to be validated and accepted by the peers, 
a transaction needs to be broadcast to the network. Special network nodes, called miners, will then timestamp it by applying a hash function into
a continuously growing chain of hash-based proof-of-work. This forms a record, called the blockchain, containing
all transactions in Bitcoin ever made, that cannot be changed without redoing the entire proof-of-work.
The public ledger is distributed to all network peers and is crucial for protection against 
double spending and modification of older transactions. The proof-of-work performed in Bitcoin is based on HashCash POW [cite],
which means new blocks (containing one or more transactions) are only accepted into the ledger 
if the hash of the block header contains a specified number
of zeros as a prefix (adapted dynamically to produce bitcoins at a constant rate). 
The header of each block contains, among other data, a 4-byte nonce, that miners permute until 
the hash fulfills the criteria. Once it does, the new block is broadcast to the network and verified by the other peers
before being added to the blockchain. This PoW takes advantage of the random nature of cryptographic hashes, making it
impossible to modify the data to obtain predictable hashes. The computation, called mining, is incentivized through fees
that are earned by the nodes performing it.

\section {Micropayment channels}

\hspace*{12pt} Unlike traditional payment methods, Bitcoin transactions are very cheap in terms
of fees, but still have a considerable cost given the mining and storing they require. The context
of Internet of Things requires a high volume of small-value payments, thus the overall fees
might reach and surpass the value of the actual transactions. In addition to this, broadcasting
several transactions to the Bitcoin network in a very short time window will trigger network anti-flooding
algorithms, which will result in either the transactions being delayed or, even worse, not relayed. 
Last, the payee of such small transactions will end up with a wallet full of ``dust'', and spending
such money is expensive fee-wise.

To address these issues, the construct of payment channels was introduced in Bitcoin. After an initial
setup process between the two participants, the payer can start sending tiny payments to the other party
off the blockchain at high speed, without paying high transaction fees, in a trust-free manner.

Consider a buyer that is interested in data generated by sensor nodes in a IoT network.
In exchange for the obtained data, it will pay the data provider in bitcoins. Since none of the
participants know each other, a zero-trust solution is necessary to reassure both the buyer that it will
not lose its bitcoins in case the sensor node does not provide the data, and that the sensor node will
not provide the promised service without getting remunerated. The construct works in two stages.
First, the buyer creates a multi-signature transaction, a shared account requiring signatures
of both participants to spend from it, that pre-allocates a certain amount of 
bitcoins for use in the channel. If the buyer signs and sends this bond transaction to the sensor node,
the node could simply broadcast it and keep the money hostage, thus the buyer keeps the transaction
private for now and creates another one, called a refund transaction, and sends it to the other
peer to sign it. This transaction refunds the
entire value to the buyer, but it time locked using the nLockTime feature of Bitcoin,
ensuring it will not become valid until some time in the future (channel lifetime). 
If the sensor node vanishes at any point, the buyer can then use the refund transaction 
to get all the money back at channel expiration time.

Once the refund has been signed by the sensor node, the buyer can safely send the signed bond transaction.
After verifying the signature, the server signs it as well and broadcasts it to the network, locking
in the money and opening the channel between the two parties. 

At this point, the work-and-pay cycles can begin. Initially, the buyer creates a new transaction
spending from the shared account and adds two outputs: one to its own address with the full amount, 
and one to the address of the payee. After signing it, the buyer sends it to the peer. 
When new data is requested from the data provider, the transaction is updated by the buyer, with increasing
value to the sensor node and decreasing value allocated to its own address. In each update cycle, the
transaction is signed and handed over to the other party. 
When the time comes and the buyer wishes
to close the channel, it notifies the sensor node, which in turn signs the transaction with the 
highest value alloted to it and broadcasts it to the network. This step closes the channel, unlocking
the buyer's remaining money and making the sensor's money available for spending. The buyer could be
tempted to broadcast an older transaction that gives less money to the sensor node than it deserved
for the provided data, but it is missing the sensor's signature. Thus, the construct of micropayment
channels prevents misbehavior from both parties.

\section{Hashed Time-Lock Contracts (HTLCs)}

\hspace*{12pt} In the proposed system

%Notes: 
% reputation systems
% bitcoin soft-fork from Lightning to secure the protocol
% Android device can encrypt data with the buyer's pubkey

\section{Related work}

\hspace*{12pt} Following the expansion trend of the Internet of Things technologies, there has been an increasing interest in 
creating secure payment protocols that allow customers to acquire sensor data efficiently. 

(IoT based on the Protocol of Bitcoin paper) introduces a new low-trust E-business architecture that is tailored 
for IoT. This architecture is based on Bitcoin, eliminating the need for a 
third-party in the process. In order to make a payment and receive the data in exchange, the buyer and the data provider 
make an offer-proposal exchange, then build a transaction that spends the required amount and publish it to the network. 
A similar approach is proposed in (When Money learns to fly), where the encrypted data is directly included in the 
blockchain after a payment is made, which only the buyer in possession of the corresponding private key can decrypt.
In both approaches, all transactions, no matter how small, need to be published to the network, which results in high 
cumulated fees and time-wise inefficiency, thus being directly affected by the scalability problem of Bitcoin (cite).

Work has also been done on micropayment protocols that reduce fee costs.
Amazon Flexible Payment Service uses a central provider that aggregates 
clients' micropayments into macropayments that are flushed to the seller at specific times. This solution
does not provide anonymity, since the central provider can keep track of all payments, and moreover,
was discontinued on June 1, 2015.
Other protocols (Micropayments Revisited) involve a probabilistic approach. Using a selection rate {\it s}, it
discards all unselected micropayments and selects one with probability {\it s} that can be deposited for an amount
{\it 1/s} times bigger than the original amount. This should ensure everyone gets, on average, the expected amount. 
However, this solution lacks anonymity, requires PKI certificates and comes closer to a bet than an actual transaction.

The Architecture of Coupon-Based, Semi-off-Line Anonymous Micropayment System for Internet of Things - 
proposes an anonymous, semi-offline micropayment system for transactions in IoT. In this approach, an electronic
coin is obtained by iteratively applying a hash function to some initial seed, thus allowing the user to spend it
in fractions, by presenting a set of hash chain nodes to the vendor. 
The protocol is designed to meet the needs of IoT transactions, however, it has limited potential to be implemented because it does 
not rely on an existing financial institution. 
Another coupon-based system has been proposed by Rivest in [PayWord and MicroMint] and was improved by Payeras-Capella 
(An efficient anonymous...) to integrate anonymity and prevent users from exceeding their account limit. The drawback of the
latter is that the financial institution needs to be contacted directly before each payment, and any unspent value is lost
in favor of the financial institution. Wilusz (Requirements and general..) solves these issues by requiring a single 
contact with the financial institution at coin issue time and allowing the user to use unspent fractions in future transactions.
However, a clearing house is necessary to lock in the coin by the vendor, which increases transactions costs, 
and poses the risk of locking the coin indefinitely.

There have been some previous projects that utilize micropayment channels to pay in bitcoins in exchange for services. 
[Paying for Internet one byte] is a proof-of-concept allowing an access point to provide Internet access to 
untrusted users for bitcoins through a micropayment channel in a convenient manner. This way owners are incentivized
to open up their access points and users receive Internet services in return. Though the idea of using micropayment
channels for several small-valued transactions does address the scalability problem of Bitcoin, establishing micropayment
channels between all pairs of buyers and service providers is rather inefficient in the context of this project.

It is worth mentioning that there have been several proposals and ideas that can be exploited to support
trustless, instant, off-the-chain Bitcoin payments
on bitcointalk.org by Mike Hearn, Alex Akselrod, hashcoin, Meni Rosenfeld, cjp, Tier Nolan etc.

On the Contracts page of Bitcoin, Mike Hearn (https://en.bitcoin.it/wiki/Contract\#Example\_2:\_Escrow\_and\_dispute\_mediation) describes an idea
on how to trade with somebody with no trust involved, based on multi-signature transactions. The funds get locked in a shared account
controlled by at least two of the three participating parties: the client, merchant and mediator. If the transaction is successful
or a refund is agreed upon, the client and the merchant can move funds. If the trade fails, the client and the mediator can agree,
and a charge-back occurs. Finally, if the goods are delivered but the client does not want to fulfill its part of the agreement,
the mediator and the merchant agree and the merchant gets the client's money. Mike also proposed the idea of trading across
multiple currencies without a third party, and Tier Nolan formalized it in a protocol that allows the exchange atomically, using
time locks and hash commits.

cjp presented a draft that combines Bitcoin and Ripple to create a high-speed, scalable, anonymous, decentralized, low-trust
payment network. In this Bitcoin-specialized variation of the Ripple system, neighboring pairs
have a shared account that is partly allocated to one of them, and the rest to the other, as agreed
between the two, which lowers the needed trust. Using sequence numbers to update this transaction
as payments in the network are made and lock times to prevent blocking the money indefinitely. 

Meni Rosenfeld proposed
a simple way of reusing existing micropayment channels instead of establishing new ones if a path between
the payer and the payee already exists. The intermediaries would then only be trusted with the amount of a single payment
from a single buyer. 

Alex Akselrod - Extensible Scalable Coopetitive High Availability Trade Optimization Network - built a proof-of-concept
for chained micropayment channels with two-phase commits. The original micropayment channel payment scheme is modified
to allow sending funds through intermediaries. Suppose Alice, Carol, and Bob have previously set-up micropayment channels
pairwise, in the given order. If Alice wants to send bitcoins to Bob through Carol, Bob first creates
a random secret R, hashes it and sends the commit hash to Alice out-of-band. Then Alice can update the values on the
channel with Carol using the commit hash, and Carol can do the same on the channel with Bob. In order to claim the money,
Bob has to reveal the secret to Carol, and Carol can then reveal the secret to Alice up the path to receive her funds.
Thus, this proposal enables friend-to-friend, instant, off-blockchain, trustless payments of arbitrary size using Bitcoin
micropayment channels.

Peter Todd's proposal in Hub-and-Spoke Payments provides the an efficient way for establishing micropayment
channels between peers with a central hub. This central entity plays the role of a router, basically fowarding
payments from the payer to the payee. Suppose Alice and Bob have previously established micropayment channels with
the hub. If Alice wishes to send bitcoins to Bob, she should normally establish a new micropayment channel with him.
However, both of them have channels opened with the hub, so Alice can send the funds to the hub, and the hub can then
forward the payment to Bob. Using Hub-and-Spoke payments, payments between buyers and service providers with a central
coordinator can be made efficiently, saving costs in terms of fees. However, the forwarding process should be enforced and secured,
part that is noted in the proposal, but without specifying an actual way to do so. 

The Lightning Paper presents a promising solution to Bitcoin's scalability problem and provides a way to
securely forward payments on a path of peers through blockchain enforced contracts. 
It solves the issue by using timelocks on a network of micropayment channels combined with Hashed Timelock Contracts (HTLC) 
- recipient generates random data R, hashes it to produce H and sends H to the sender of funds, together with its bitcoin address. 
Sender routes its payment to the receiver and when an updated transaction is received, the recipient may elect to redeem the 
transaction by disclosing the random data R (which pulls the funds from the sender).
With the introduction of a new sighash
type which solves malleability, the proposed protocol allows offchain transactions between untrusted parties with fully enforceable
contracts, making Bitcoin scale to billions of users.

For the sake of completeness of this literature review, we mention the TilePay project, which promises a decentralized
payment system based Bitcoin for real-time access to IoT sensors, based on micropayments. In a partnership
with Cryptotronix, TilePay wants to enable cryptocurrency payments to IoT devices. However, since the announcement
in December 2014, no work or detailed information on how they would achieve that has been published.

\chapter{Design}

\chapter{Implementation}

\chapter{Evaluation}

\chapter{Conclusion}

\chapter{References}

% This displays the bibliography for all cited external documents. All references have to be defined in the file references.bib and can then be cited from within this document.
\bibliographystyle{splncs}
\bibliography{references}

% This creates an appendix chapter, comment if not needed.
\appendix
\chapter{Appendix Chapter}

\end{document}